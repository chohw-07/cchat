<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CCHAT - ì‹¬í”Œ P2P ì±„íŒ…</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
  <style>
    :root {
      --main-bg: #2e3440;
      --sidebar-bg: #3b4252;
      --header-bg: #434c5e;
      --text-color: #eceff4;
      --input-bg: #4c566a;
      --highlight: #5e81ac;
      --accent: #81a1c1;
      --success: #a3be8c;
      --error: #bf616a;
      --warning: #ebcb8b;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }
    
    body {
      background-color: var(--main-bg);
      color: var(--text-color);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .app-container {
      display: flex;
      height: 100%;
      overflow: hidden;
    }
    
    .sidebar {
      width: 280px;
      background-color: var(--sidebar-bg);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      border-right: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .header {
      padding: 16px;
      background-color: var(--header-bg);
      font-weight: bold;
      font-size: 16px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .room-list {
      flex-grow: 1;
      padding: 10px;
      overflow-y: auto;
    }
    
    .room-item {
      padding: 10px 14px;
      margin-bottom: 4px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
    }
    
    .room-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .room-item.active {
      background-color: var(--accent);
      color: white;
    }
    
    .room-item-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: var(--highlight);
      margin-right: 12px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
    }
    
    .room-item-info {
      flex-grow: 1;
      overflow: hidden;
    }
    
    .room-item-name {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .room-item-badge {
      background-color: var(--highlight);
      color: white;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 8px;
    }
    
    .content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .chat-header {
      padding: 16px;
      background-color: var(--header-bg);
      border-bottom: 1px solid rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
    }
    
    .chat-header h2 {
      font-size: 18px;
      font-weight: 600;
      margin-right: auto;
    }
    
    .chat-area {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .message {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--highlight);
      margin-right: 16px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
    }
    
    .message-avatar.admin {
      background-color: var(--warning);
    }
    
    .message-avatar.manager {
      background-color: var(--success);
    }
    
    .message-content {
      flex-grow: 1;
      max-width: calc(100% - 60px);
    }
    
    .message-sender {
      font-weight: bold;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
    }
    
    .sender-badge {
      font-size: 11px;
      padding: 1px 6px;
      border-radius: 10px;
      margin-left: 6px;
      font-weight: normal;
    }
    
    .sender-badge.host {
      background-color: var(--warning);
      color: #2e3440;
    }
    
    .sender-badge.manager {
      background-color: var(--success);
      color: #2e3440;
    }
    
    .message-text {
      color: var(--text-color);
      word-break: break-word;
      line-height: 1.5;
      background-color: rgba(255, 255, 255, 0.05);
      padding: 10px 12px;
      border-radius: 6px;
    }
    
    .input-area {
      padding: 16px;
      display: flex;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.2);
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .message-input {
      flex-grow: 1;
      padding: 12px 16px;
      border-radius: 6px;
      background-color: var(--input-bg);
      border: none;
      color: var(--text-color);
      outline: none;
      font-size: 15px;
      transition: box-shadow 0.2s ease;
    }
    
    .message-input:focus {
      box-shadow: 0 0 0 2px var(--accent);
    }
    
    .emoji-button {
      margin-right: 10px;
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
    }
    
    .emoji-button:hover {
      transform: scale(1.1);
    }
    
    .emoji-picker {
      position: absolute;
      bottom: 80px;
      right: 16px;
      background-color: var(--sidebar-bg);
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      padding: 12px;
      display: none;
      grid-template-columns: repeat(8, 1fr);
      gap: 8px;
      max-width: 360px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 10;
    }
    
    .emoji-picker.active {
      display: grid;
    }
    
    .emoji-item {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
    
    .emoji-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .button {
      padding: 10px 16px;
      margin-left: 10px;
      background-color: var(--highlight);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      font-size: 14px;
    }
    
    .button:hover {
      background-color: var(--accent);
      transform: translateY(-2px);
    }
    
    .button:active {
      transform: translateY(0);
    }
    
    .button:disabled {
      background-color: #72767d;
      cursor: not-allowed;
      transform: none;
    }
    
    .button.primary {
      background-color: var(--highlight);
    }
    
    .button.danger {
      background-color: var(--error);
    }
    
    .button.success {
      background-color: var(--success);
    }
    
    .controls {
      display: flex;
      margin-top: 16px;
    }
    
    .user-status {
      margin-left: 10px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      display: flex;
      align-items: center;
    }
    
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }
    
    .status-indicator.online {
      background-color: var(--success);
    }
    
    .status-indicator.connecting {
      background-color: var(--warning);
    }
    
    .room-input {
      width: 100%;
      padding: 12px;
      margin-bottom: 14px;
      background-color: var(--input-bg);
      border: none;
      border-radius: 6px;
      color: var(--text-color);
      outline: none;
      font-size: 15px;
      transition: box-shadow 0.2s ease;
    }
    
    .room-input:focus {
      box-shadow: 0 0 0 2px var(--accent);
    }
    
    .input-group {
      margin-bottom: 16px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .checkbox-group input[type="checkbox"] {
      margin-right: 8px;
    }
    
    .welcome-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 20px;
      background: linear-gradient(135deg, var(--main-bg), var(--header-bg));
    }
    
    .logo {
      font-size: 40px;
      font-weight: 800;
      margin-bottom: 10px;
      color: var(--accent);
      letter-spacing: 2px;
    }
    
    .logo-badge {
      font-size: 14px;
      background-color: var(--accent);
      color: white;
      padding: 4px 8px;
      border-radius: 20px;
      margin-left: 8px;
      vertical-align: middle;
      font-weight: normal;
    }
    
    .welcome-subtitle {
      margin-bottom: 30px;
      font-size: 16px;
      color: rgba(255, 255, 255, 0.7);
      text-align: center;
    }
    
    .welcome-box {
      background-color: var(--sidebar-bg);
      padding: 30px;
      border-radius: 10px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    
    .tab-container {
      margin-bottom: 24px;
      display: flex;
      border-radius: 8px;
      overflow: hidden;
      background-color: rgba(0, 0, 0, 0.2);
    }
    
    .tab {
      flex: 1;
      padding: 12px 0;
      text-align: center;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .tab.active {
      background-color: var(--highlight);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .action-buttons .button {
      flex: 1;
      margin: 0;
    }
    
    .notification-permission {
      margin-top: 30px;
      background-color: rgba(255, 255, 255, 0.05);
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .notification-text {
      margin-bottom: 12px;
    }
    
    /* Setup screens */
    .welcome-screen, .chat-container, .public-rooms-screen {
      display: none;
    }
    
    .active-screen {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    /* Public rooms styling */
    .public-rooms-screen {
      background-color: var(--main-bg);
    }
    
    .public-rooms-header {
      padding: 16px;
      background-color: var(--header-bg);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .public-rooms-header h2 {
      font-size: 20px;
      font-weight: 600;
    }
    
    .public-rooms-content {
      padding: 20px;
      overflow-y: auto;
      flex-grow: 1;
    }
    
    .public-room-card {
      background-color: var(--sidebar-bg);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
    }
    
    .public-room-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .public-room-icon {
      width: 48px;
      height: 48px;
      background-color: var(--highlight);
      border-radius: 16px;
      margin-right: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      flex-shrink: 0;
    }
    
    .public-room-info {
      flex-grow: 1;
    }
    
    .public-room-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .public-room-participants {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
    }
    
    .public-room-join {
      background-color: var(--highlight);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }
    
    .public-room-join:hover {
      background-color: var(--accent);
    }
    
    .no-rooms-message {
      text-align: center;
      padding: 40px 0;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: rgba(0, 0, 0, 0.8);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 0;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      pointer-events: none;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    .context-menu {
      position: absolute;
      background-color: var(--sidebar-bg);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      padding: 8px 0;
      min-width: 160px;
      z-index: 1000;
      display: none;
    }
    
    .context-menu.active {
      display: block;
    }
    
    .context-menu-item {
      padding: 8px 16px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      font-size: 14px;
    }
    
    .context-menu-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .context-menu-item.danger {
      color: var(--error);
    }
    
    .invite-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .invite-modal.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .invite-modal-content {
      background-color: var(--sidebar-bg);
      border-radius: 10px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .invite-modal.active .invite-modal-content {
      transform: translateY(0);
    }
    
    .invite-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .invite-modal-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .invite-modal-close {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 20px;
      cursor: pointer;
    }
    
    .invite-code-display {
      background-color: rgba(0, 0, 0, 0.2);
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      font-size: 24px;
      letter-spacing: 2px;
      margin-bottom: 16px;
      user-select: all;
    }
    
    .confirmation-dialog {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .confirmation-dialog.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .confirmation-content {
      background-color: var(--sidebar-bg);
      border-radius: 10px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }
    
    .confirmation-message {
      margin-bottom: 20px;
      font-size: 16px;
    }
    
    .confirmation-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    /* Join request styling */
    .join-request {
      background-color: rgba(94, 129, 172, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .join-request-info {
      display: flex;
      align-items: center;
    }
    
    .join-request-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--highlight);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-weight: bold;
      color: white;
    }
    
    .join-request-name {
      font-weight: 500;
    }
    
    .join-request-buttons {
      display: flex;
      gap: 8px;
    }
    
    .join-request-button {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .join-request-button.accept {
      background-color: var(--success);
      color: white;
    }
    
    .join-request-button.reject {
      background-color: var(--error);
      color: white;
    }
    
    .footer {
      padding: 8px 16px;
      text-align: center;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      background-color: rgba(0, 0, 0, 0.2);
    }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--text-color);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(94, 129, 172, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(94, 129, 172, 0); }
      100% { box-shadow: 0 0 0 0 rgba(94, 129, 172, 0); }
    }
  </style>
</head>
<body>
  <!-- ì‹œì‘ í™”ë©´ -->
  <div id="welcome-screen" class="welcome-screen active-screen">
    <div class="logo">CCHAT <span class="logo-badge">P2P</span></div>
    <p class="welcome-subtitle">ì„œë²„ ì—†ì´ ë™ì‘í•˜ëŠ” ê°„ë‹¨í•œ P2P ì±„íŒ…</p>
    
    <div class="welcome-box">
      <div class="tab-container">
        <div class="tab active" data-tab="create">ìƒˆ ë°© ë§Œë“¤ê¸°</div>
        <div class="tab" data-tab="join">ë°© ì°¸ì—¬í•˜ê¸°</div>
        <div class="tab" data-tab="public">ê³µê°œ ë°© ì°¾ê¸°</div>
      </div>
      
      <div class="tab-content active" data-tab="create">
        <div class="input-group">
          <label for="nickname-create">ë‹‰ë„¤ì„</label>
          <input type="text" id="nickname-create" class="room-input" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="input-group">
          <label for="room-name">ë°© ì´ë¦„</label>
          <input type="text" id="room-name" class="room-input" placeholder="ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="input-group">
          <label>ì´ˆëŒ€ ì½”ë“œ í˜•ì‹</label>
          <div style="display: flex; gap: 10px; margin-bottom: 14px;">
            <div style="flex: 1;">
              <input type="radio" id="code-type-letters" name="code-type" value="letters" checked>
              <label for="code-type-letters">3ìë¦¬ ë¬¸ì(ABC)</label>
            </div>
            <div style="flex: 1;">
              <input type="radio" id="code-type-numbers" name="code-type" value="numbers">
              <label for="code-type-numbers">4ìë¦¬ ìˆ«ì(1234)</label>
            </div>
          </div>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="public-room" checked>
          <label for="public-room">ê³µê°œ ë°©ìœ¼ë¡œ ì„¤ì • (ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë°© ëª©ë¡ì—ì„œ ë³¼ ìˆ˜ ìˆìŒ)</label>
        </div>
        <button id="create-room-confirm" class="button primary" style="width: 100%">ë°© ë§Œë“¤ê¸°</button>
      </div>
      
      <div class="tab-content" data-tab="join">
        <div class="input-group">
          <label for="nickname-join">ë‹‰ë„¤ì„</label>
          <input type="text" id="nickname-join" class="room-input" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="input-group">
          <label for="room-code">ì´ˆëŒ€ ì½”ë“œ</label>
          <input type="text" id="room-code" class="room-input" placeholder="ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <button id="join-room-confirm" class="button primary" style="width: 100%">ë°© ì°¸ì—¬í•˜ê¸°</button>
      </div>
      
      <div class="tab-content" data-tab="public">
        <p style="margin-bottom: 16px;">ê³µê°œëœ ë°© ëª©ë¡ì„ í™•ì¸í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
        <button id="find-public-rooms" class="button primary" style="width: 100%">ê³µê°œ ë°© ì°¾ê¸°</button>
      </div>
      
      <div class="notification-permission">
        <p class="notification-text">CCHATì€ ë°ìŠ¤í¬í†± ì•Œë¦¼ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ ë©”ì‹œì§€ë¥¼ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.</p>
        <button id="enable-notifications" class="button">ë°ìŠ¤í¬í†± ì•Œë¦¼ í™œì„±í™”</button>
      </div>
    </div>
    
    <div class="footer">
      Made by OCGK123 Â© 2025
    </div>
  </div>
  
  <!-- ê³µê°œ ë°© ëª©ë¡ í™”ë©´ -->
  <div id="public-rooms-screen" class="public-rooms-screen">
    <div class="public-rooms-header">
      <h2>ê³µê°œ ë°© ëª©ë¡</h2>
      <button id="back-to-welcome-from-public" class="button">ë’¤ë¡œ ê°€ê¸°</button>
    </div>
    <div id="public-rooms-content" class="public-rooms-content">
      <div id="public-rooms-loading" style="text-align: center; padding: 40px;">
        <div class="spinner"></div>
        <p style="margin-top: 16px;">ê³µê°œ ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
      <div id="public-rooms-list" style="display: none;"></div>
      <div id="no-public-rooms" class="no-rooms-message" style="display: none;">
        <p>í˜„ì¬ ê³µê°œëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <button id="create-room-from-public" class="button primary" style="margin-top: 16px;">ìƒˆ ë°© ë§Œë“¤ê¸°</button>
      </div>
    </div>
  </div>
  
  <!-- ì±„íŒ… í™”ë©´ -->
  <div id="chat-container" class="chat-container">
    <div class="app-container">
      <div class="sidebar">
        <div class="header">
          <span id="current-room-name">ë°© ì´ë¦„</span>
          <div class="tooltip">
            <button id="invite-button" class="button" style="margin: 0; padding: 6px 10px;">ì´ˆëŒ€</button>
            <span class="tooltiptext">ì´ˆëŒ€ ì½”ë“œ ë³´ê¸°</span>
          </div>
        </div>
        <div class="room-list">
          <div class="header" style="background: transparent;">ì°¸ì—¬ì</div>
          <div id="participants-list"></div>
          
          <div id="join-requests-container" style="margin-top: 16px; display: none;">
            <div class="header" style="background: transparent;">ì°¸ê°€ ìš”ì²­</div>
            <div id="join-requests-list"></div>
          </div>
        </div>
        <div style="margin-top: auto; padding: 16px;">
          <button id="leave-room" class="button danger" style="width: 100%;">ë°© ë‚˜ê°€ê¸°</button>
        </div>
      </div>
      
      <div class="content">
        <div class="chat-header">
          <h2 id="room-header">ë°© ì´ë¦„</h2>
          <span id="connected-status" class="user-status">
            <span class="status-indicator online"></span>
            ì—°ê²°ë¨
          </span>
        </div>
        <div id="chat-area" class="chat-area"></div>
        <div class="input-area">
          <button id="emoji-button" class="emoji-button">ğŸ˜Š</button>
          <div id="emoji-picker" class="emoji-picker"></div>
          <input type="text" id="message-input" class="message-input" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
          <button id="send-button" class="button">ë³´ë‚´ê¸°</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ì´ˆëŒ€ ì½”ë“œ ëª¨ë‹¬ -->
  <div id="invite-modal" class="invite-modal">
    <div class="invite-modal-content">
      <div class="invite-modal-header">
        <h3 class="invite-modal-title">ì´ˆëŒ€ ì½”ë“œ</h3>
        <button id="invite-modal-close" class="invite-modal-close">&times;</button>
      </div>
      <div id="invite-code-display" class="invite-code-display"></div>
      <p style="margin-bottom: 16px; text-align: center;">ì´ ì½”ë“œë¥¼ ê³µìœ í•˜ì—¬ ë‹¤ë¥¸ ì‚¬ëŒì„ ì´ˆëŒ€í•˜ì„¸ìš”.</p>
      <button id="copy-invite-code" class="button primary" style="width: 100%;">ì½”ë“œ ë³µì‚¬</button>
    </div>
  </div>
  
  <!-- ë§¥ë½ ë©”ë‰´ (ìš°í´ë¦­ ë©”ë‰´) -->
  <div id="context-menu" class="context-menu"></div>
  
  <!-- í™•ì¸ ëŒ€í™”ìƒì -->
  <div id="confirmation-dialog" class="confirmation-dialog">
    <div class="confirmation-content">
      <div id="confirmation-message" class="confirmation-message"></div>
      <div class="confirmation-buttons">
        <button id="confirmation-cancel" class="button">ì·¨ì†Œ</button>
        <button id="confirmation-confirm" class="button primary">í™•ì¸</button>
      </div>
    </div>
  </div>

  <script>
    // ì´ëª¨ì§€ ëª©ë¡
    const commonEmojis = [
      'ğŸ˜Š', 'ğŸ˜‚', 'â¤ï¸', 'ğŸ‘', 'ğŸ‰', 'âœ¨', 'ğŸ”¥', 'ğŸ‘€', 'ğŸ™Œ', 'ğŸ‘‹',
      'ğŸ˜', 'ğŸ¤”', 'ğŸ˜…', 'ğŸ˜', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¡', 'ğŸ¥º', 'ğŸ˜´', 'ğŸ¤£',
      'ğŸ‘', 'ğŸ’ª', 'ğŸ¤', 'ğŸ™', 'ğŸ¤·', 'ğŸƒ', 'ğŸ’¯', 'ğŸŠ', 'ğŸ', 'ğŸ†',
      'ğŸ’–', 'ğŸ’™', 'ğŸ’š', 'ğŸ’›', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ’', 'ğŸ’•', 'ğŸ’“',
      'ğŸ‘‘', 'ğŸŒŸ', 'â­', 'ğŸ’«', 'ğŸŒˆ', 'ğŸ¯', 'ğŸµ', 'ğŸ§', 'ğŸ“±', 'ğŸ’»'
    ];
    
    // í•„ìš”í•œ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    const welcomeScreen = document.getElementById('welcome-screen');
    const publicRoomsScreen = document.getElementById('public-rooms-screen');
    const chatContainer = document.getElementById('chat-container');
    const createRoomConfirmBtn = document.getElementById('create-room-confirm');
    const joinRoomConfirmBtn = document.getElementById('join-room-confirm');
    const findPublicRoomsBtn = document.getElementById('find-public-rooms');
    const backToWelcomeFromPublicBtn = document.getElementById('back-to-welcome-from-public');
    const createRoomFromPublicBtn = document.getElementById('create-room-from-public');
    const publicRoomsList = document.getElementById('public-rooms-list');
    const publicRoomsLoading = document.getElementById('public-rooms-loading');
    const noPublicRooms = document.getElementById('no-public-rooms');
    const nicknameCreateInput = document.getElementById('nickname-create');
    const nicknameJoinInput = document.getElementById('nickname-join');
    const roomNameInput = document.getElementById('room-name');
    const roomCodeInput = document.getElementById('room-code');
    const publicRoomCheckbox = document.getElementById('public-room');
    const currentRoomNameEl = document.getElementById('current-room-name');
    const roomHeaderEl = document.getElementById('room-header');
    const inviteButton = document.getElementById('invite-button');
    const inviteModal = document.getElementById('invite-modal');
    const inviteModalClose = document.getElementById('invite-modal-close');
    const inviteCodeDisplay = document.getElementById('invite-code-display');
    const copyInviteCodeBtn = document.getElementById('copy-invite-code');
    const leaveRoomBtn = document.getElementById('leave-room');
    const participantsList = document.getElementById('participants-list');
    const joinRequestsList = document.getElementById('join-requests-list');
    const joinRequestsContainer = document.getElementById('join-requests-container');
    const connectedStatus = document.getElementById('connected-status');
    const chatArea = document.getElementById('chat-area');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const enableNotificationsBtn = document.getElementById('enable-notifications');
    const contextMenu = document.getElementById('context-menu');
    const confirmationDialog = document.getElementById('confirmation-dialog');
    const confirmationMessage = document.getElementById('confirmation-message');
    const confirmationCancel = document.getElementById('confirmation-cancel');
    const confirmationConfirm = document.getElementById('confirmation-confirm');
    const emojiButton = document.getElementById('emoji-button');
    const emojiPicker = document.getElementById('emoji-picker');
    
    // íƒ­ ê´€ë ¨ ìš”ì†Œ
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    // ìƒíƒœ ê´€ë¦¬
    let peer = null;
    let connections = {};
    let currentRoomId = null;
    let currentRoomName = '';
    let nickname = '';
    let participants = {};
    let notificationsEnabled = false;
    let isPublicRoom = true;
    let joinRequests = {};
    let confirmationCallback = null;
    let publicRooms = [];
    let publicRoomPrefix = 'public-';
    
    // ì´ˆê¸°í™” í•¨ìˆ˜
    function init() {
      // ì´ëª¨ì§€ í”½ì»¤ ì´ˆê¸°í™”
      initEmojiPicker();
      
      // íƒ­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');
          
          // í™œì„±í™”ëœ íƒ­ ë³€ê²½
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // í™œì„±í™”ëœ íƒ­ ì»¨í…ì¸  ë³€ê²½
          tabContents.forEach(content => {
            if (content.getAttribute('data-tab') === tabId) {
              content.classList.add('active');
            } else {
              content.classList.remove('active');
            }
          });
        });
      });
      
      // ì•Œë¦¼ ê¶Œí•œ í™•ì¸
      checkNotificationPermission();
      
      // í˜ì´ì§€ ë¡œë“œì‹œ ì•Œë¦¼ ê¶Œí•œ í•„ìˆ˜ ì²˜ë¦¬
      if (!notificationsEnabled) {
        enableNotificationsBtn.classList.add('primary');
        enableNotificationsBtn.style.animation = 'pulse 1s infinite';
      }
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      setupEventListeners();
      
      // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì²˜ë¦¬
      document.addEventListener('click', () => {
        contextMenu.classList.remove('active');
      });
    }
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    function setupEventListeners() {
      // ë°© ë§Œë“¤ê¸° ë²„íŠ¼
      createRoomConfirmBtn.addEventListener('click', () => {
        if (!notificationsEnabled) {
          showConfirmation('ì•Œë¦¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
            requestNotificationPermission(() => {
              handleCreateRoom();
            });
          });
          return;
        }
        
        handleCreateRoom();
      });
      
      // ë°© ì°¸ì—¬ ë²„íŠ¼
      joinRoomConfirmBtn.addEventListener('click', () => {
        if (!notificationsEnabled) {
          showConfirmation('ì•Œë¦¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
            requestNotificationPermission(() => {
              handleJoinRoom();
            });
          });
          return;
        }
        
        handleJoinRoom();
      });
      
      // ê³µê°œ ë°© ì°¾ê¸° ë²„íŠ¼
      findPublicRoomsBtn.addEventListener('click', () => {
        if (!notificationsEnabled) {
          showConfirmation('ì•Œë¦¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
            requestNotificationPermission(() => {
              showPublicRoomsScreen();
            });
          });
          return;
        }
        
        showPublicRoomsScreen();
      });
      
      // ê³µê°œ ë°© í™”ë©´ì—ì„œ ë’¤ë¡œê°€ê¸° ë²„íŠ¼
      backToWelcomeFromPublicBtn.addEventListener('click', () => {
        showScreen('welcome-screen');
      });
      
      // ê³µê°œ ë°© ì—†ì„ ë•Œ ìƒì„± ë²„íŠ¼
      createRoomFromPublicBtn.addEventListener('click', () => {
        showScreen('welcome-screen');
        // ìƒˆ ë°© ë§Œë“¤ê¸° íƒ­ìœ¼ë¡œ ì´ë™
        tabs[0].click();
      });
      
      // ë©”ì‹œì§€ ë³´ë‚´ê¸° ë²„íŠ¼
      sendButton.addEventListener('click', sendMessage);
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // ì´ˆëŒ€ ë²„íŠ¼
      inviteButton.addEventListener('click', () => {
        showInviteModal();
      });
      
      // ì´ˆëŒ€ ëª¨ë‹¬ ë‹«ê¸°
      inviteModalClose.addEventListener('click', () => {
        inviteModal.classList.remove('active');
      });
      
      // ì´ˆëŒ€ ì½”ë“œ ë³µì‚¬
      copyInviteCodeBtn.addEventListener('click', () => {
        const code = inviteCodeDisplay.textContent;
        navigator.clipboard.writeText(code)
          .then(() => {
            copyInviteCodeBtn.textContent = 'ë³µì‚¬ë¨!';
            copyInviteCodeBtn.classList.add('success');
            
            setTimeout(() => {
              copyInviteCodeBtn.textContent = 'ì½”ë“œ ë³µì‚¬';
              copyInviteCodeBtn.classList.remove('success');
            }, 2000);
          })
          .catch(err => {
            console.error('ì½”ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
            copyInviteCodeBtn.textContent = 'ë³µì‚¬ ì‹¤íŒ¨';
            copyInviteCodeBtn.classList.add('danger');
            
            setTimeout(() => {
              copyInviteCodeBtn.textContent = 'ì½”ë“œ ë³µì‚¬';
              copyInviteCodeBtn.classList.remove('danger');
            }, 2000);
          });
      });
      
      // ë°© ë‚˜ê°€ê¸° ë²„íŠ¼
      leaveRoomBtn.addEventListener('click', () => {
        showConfirmation('ì •ë§ ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?', leaveRoom);
      });
      
      // ì•Œë¦¼ í™œì„±í™” ë²„íŠ¼
      enableNotificationsBtn.addEventListener('click', () => {
        requestNotificationPermission();
      });
      
      // í™•ì¸ ëŒ€í™”ìƒì ë²„íŠ¼ë“¤
      confirmationCancel.addEventListener('click', () => {
        confirmationDialog.classList.remove('active');
        confirmationCallback = null;
      });
      
      confirmationConfirm.addEventListener('click', () => {
        confirmationDialog.classList.remove('active');
        if (confirmationCallback) {
          confirmationCallback();
          confirmationCallback = null;
        }
      });
      
      // ì´ëª¨ì§€ ë²„íŠ¼
      emojiButton.addEventListener('click', (e) => {
        e.stopPropagation();
        emojiPicker.classList.toggle('active');
      });
      
      // ì´ëª¨ì§€ í”½ì»¤ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
      document.addEventListener('click', (e) => {
        if (!emojiPicker.contains(e.target) && e.target !== emojiButton) {
          emojiPicker.classList.remove('active');
        }
      });
    }
    
    // ì•Œë¦¼ ê¶Œí•œ í™•ì¸
    function checkNotificationPermission() {
      if (!('Notification' in window)) {
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        enableNotificationsBtn.disabled = true;
        enableNotificationsBtn.textContent = 'ì•Œë¦¼ ì§€ì›ë˜ì§€ ì•ŠìŒ';
        return;
      }
      
      if (Notification.permission === 'granted') {
        notificationsEnabled = true;
        enableNotificationsBtn.textContent = 'ì•Œë¦¼ í™œì„±í™”ë¨';
        enableNotificationsBtn.disabled = true;
      }
    }
    
    // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
    function requestNotificationPermission(callback) {
      if (!('Notification' in window)) {
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
      
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          notificationsEnabled = true;
          enableNotificationsBtn.textContent = 'ì•Œë¦¼ í™œì„±í™”ë¨';
          enableNotificationsBtn.disabled = true;
          enableNotificationsBtn.style.animation = 'none';
          
          // í…ŒìŠ¤íŠ¸ ì•Œë¦¼
          new Notification('CCHAT - ì•Œë¦¼ í™œì„±í™”ë¨', {
            body: 'ì´ì œ ìƒˆ ë©”ì‹œì§€ê°€ ì˜¤ë©´ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ’¬</text></svg>'
          });
          
          if (callback) callback();
        } else {
          alert('ì±„íŒ…ì„ ì‹œì‘í•˜ë ¤ë©´ ì•Œë¦¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
        }
      });
    }
    
    // ë°© ë§Œë“¤ê¸° ì²˜ë¦¬
    function handleCreateRoom() {
      const userNickname = nicknameCreateInput.value.trim();
      const roomName = roomNameInput.value.trim();
      isPublicRoom = publicRoomCheckbox.checked;
      
      if (!userNickname || !roomName) {
        alert('ë‹‰ë„¤ì„ê³¼ ë°© ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      createRoom(userNickname, roomName);
    }
    
    // ë°© ì°¸ì—¬ ì²˜ë¦¬
    function handleJoinRoom() {
      const userNickname = nicknameJoinInput.value.trim();
      let roomCode = roomCodeInput.value.trim();
      
      if (!userNickname || !roomCode) {
        alert('ë‹‰ë„¤ì„ê³¼ ì´ˆëŒ€ ì½”ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ëŒ€ë¬¸ìë¡œ ë³€í™˜
      roomCode = roomCode.toUpperCase();
      
      joinRoom(userNickname, roomCode, true);
    }
    
    // í™”ë©´ ì „í™˜ í•¨ìˆ˜
    function showScreen(screenId) {
      [welcomeScreen, publicRoomsScreen, chatContainer].forEach(screen => {
        screen.classList.remove('active-screen');
      });
      document.getElementById(screenId).classList.add('active-screen');
    }
    
    // ê³µê°œ ë°© í™”ë©´ í‘œì‹œ
    function showPublicRoomsScreen() {
      showScreen('public-rooms-screen');
      fetchPublicRooms();
    }
    
    // ê³µê°œ ë°© ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    function fetchPublicRooms() {
      publicRoomsLoading.style.display = 'block';
      publicRoomsList.style.display = 'none';
      noPublicRooms.style.display = 'none';
      
      // ì‹¤ì œ í™œì„±í™”ëœ ê³µê°œ ë°© ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
      findActivePublicRooms().then(rooms => {
        publicRooms = rooms;
        publicRoomsLoading.style.display = 'none';
        
        if (rooms.length === 0) {
          noPublicRooms.style.display = 'block';
        } else {
          renderPublicRooms(rooms);
          publicRoomsList.style.display = 'block';
        }
      }).catch(err => {
        console.error('ê³µê°œ ë°© ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', err);
        publicRoomsLoading.style.display = 'none';
        noPublicRooms.style.display = 'block';
      });
    }
    
    // í™œì„±í™”ëœ ê³µê°œ ë°© ì°¾ê¸°
    async function findActivePublicRooms() {
      return new Promise((resolve, reject) => {
        const tempPeer = new Peer();
        const rooms = [];
        const checkedPeers = new Set();
        
        tempPeer.on('open', () => {
          // ì—°ê²° ì‹œë„ íšŸìˆ˜ ì¶”ì 
          let connectionAttempts = 0;
          const maxAttempts = 20;
          
          // 1ë¶„ í›„ ê°•ì œ ì¢…ë£Œ íƒ€ì´ë¨¸
          const timeoutId = setTimeout(() => {
            tempPeer.destroy();
            resolve(rooms);
          }, 10000);
          
          // í™œì„±í™”ëœ ë°©ì„ ì°¾ê¸° ìœ„í•œ í•¨ìˆ˜
          function tryConnectToRoom() {
            if (connectionAttempts >= maxAttempts) {
              clearTimeout(timeoutId);
              tempPeer.destroy();
              return resolve(rooms);
            }
            
            // ëœë¤ ì½”ë“œë¡œ ê³µê°œ ë°© ID ìƒì„± (ë¬¸ì ë˜ëŠ” ìˆ«ì)
            let potentialId;
            if (Math.random() > 0.5) {
              // 3ìë¦¬ ì•ŒíŒŒë²³ ì½”ë“œ ì‹œë„
              potentialId = publicRoomPrefix + generateRandomCode(3);
            } else {
              // 4ìë¦¬ ìˆ«ì ì½”ë“œ ì‹œë„
              potentialId = publicRoomPrefix + generateRandomNumberCode(4);
            }
            
            if (checkedPeers.has(potentialId)) {
              connectionAttempts++;
              return tryConnectToRoom();
            }
            
            checkedPeers.add(potentialId);
            connectionAttempts++;
            
            const conn = tempPeer.connect(potentialId);
            
            conn.on('open', () => {
              conn.send({
                type: 'room_info_request',
                source: tempPeer.id
              });
            });
            
            conn.on('data', data => {
              if (data.type === 'room_info_response') {
                rooms.push({
                  id: potentialId,
                  name: data.roomName,
                  participants: data.participantsCount
                });
              }
              
              // ë‹¤ìŒ ì—°ê²° ì‹œë„
              tryConnectToRoom();
            });
            
            conn.on('error', () => {
              // ë‹¤ìŒ ì—°ê²° ì‹œë„
              tryConnectToRoom();
            });
          }
          
          // ì²« ì—°ê²° ì‹œë„ ì‹œì‘
          tryConnectToRoom();
        });
        
        tempPeer.on('error', (err) => {
          console.error('ê³µê°œ ë°© ê²€ìƒ‰ ì˜¤ë¥˜:', err);
          tempPeer.destroy();
          resolve([]); // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë¹ˆ ë°°ì—´ ë°˜í™˜
        });
      });
    }
    
    // ê³µê°œ ë°© ëª©ë¡ ë Œë”ë§
    function renderPublicRooms(rooms) {
      publicRoomsList.innerHTML = '';
      
      rooms.forEach(room => {
        const roomCard = document.createElement('div');
        roomCard.className = 'public-room-card';
        
        const roomIcon = document.createElement('div');
        roomIcon.className = 'public-room-icon';
        roomIcon.textContent = room.name.charAt(0).toUpperCase();
        
        const roomInfo = document.createElement('div');
        roomInfo.className = 'public-room-info';
        
        const roomName = document.createElement('div');
        roomName.className = 'public-room-name';
        roomName.textContent = room.name;
        
        const roomParticipants = document.createElement('div');
        roomParticipants.className = 'public-room-participants';
        roomParticipants.textContent = `ì°¸ì—¬ì ${room.participants} ëª…`;
        
        const joinButton = document.createElement('button');
        joinButton.className = 'public-room-join';
        joinButton.textContent = 'ì°¸ì—¬í•˜ê¸°';
        joinButton.addEventListener('click', () => {
          // ë‹‰ë„¤ì„ ì…ë ¥ í™•ì¸
          let userNickname = nicknameCreateInput.value.trim() || nicknameJoinInput.value.trim();
          
          if (!userNickname) {
            userNickname = prompt('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:');
            if (!userNickname) return;
          }
          
          joinRoom(userNickname, room.id.slice(-3), false);
        });
        
        roomInfo.appendChild(roomName);
        roomInfo.appendChild(roomParticipants);
        
        roomCard.appendChild(roomIcon);
        roomCard.appendChild(roomInfo);
        roomCard.appendChild(joinButton);
        
        publicRoomsList.appendChild(roomCard);
      });
    }
    
    // ì•Œë¦¼ í‘œì‹œ
    function showNotification(title, message) {
      if (notificationsEnabled && document.visibilityState !== 'visible') {
        new Notification(title, {
          body: message,
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ’¬</text></svg>'
        });
      }
    }
    
    // ì´ëª¨ì§€ í”½ì»¤ ì´ˆê¸°í™”
    function initEmojiPicker() {
      // ì´ëª¨ì§€ ëª©ë¡ ì¶”ê°€
      commonEmojis.forEach(emoji => {
        const emojiItem = document.createElement('div');
        emojiItem.className = 'emoji-item';
        emojiItem.textContent = emoji;
        emojiItem.addEventListener('click', () => {
          messageInput.value += emoji;
          messageInput.focus();
          emojiPicker.classList.remove('active');
        });
        
        emojiPicker.appendChild(emojiItem);
      });
    }
    
    // ì´ˆëŒ€ ëª¨ë‹¬ í‘œì‹œ
    function showInviteModal() {
      inviteCodeDisplay.textContent = currentRoomId.slice(-3);
      inviteModal.classList.add('active');
    }
    
    // í™•ì¸ ëŒ€í™”ìƒì í‘œì‹œ
    function showConfirmation(message, callback) {
      confirmationMessage.textContent = message;
      confirmationCallback = callback;
      confirmationDialog.classList.add('active');
    }
    
    // ë©”ì‹œì§€ ë³´ë‚´ê¸° í•¨ìˆ˜
    function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;
      
      // ë©”ì‹œì§€ ê°ì²´ ìƒì„±
      const messageObj = {
        type: 'message',
        sender: nickname,
        content: message,
        timestamp: Date.now(),
        role: getMyRole()
      };
      
      // ëª¨ë“  ì—°ê²°ì— ë©”ì‹œì§€ ì „ì†¡
      Object.values(connections).forEach(conn => {
        conn.send(messageObj);
      });
      
      // ë‚´ í™”ë©´ì— ë©”ì‹œì§€ í‘œì‹œ
      displayMessage(messageObj);
      
      // ì…ë ¥ì°½ ë¹„ìš°ê¸°
      messageInput.value = '';
    }
    
    // í˜„ì¬ ìì‹ ì˜ ì—­í•  ê°€ì ¸ì˜¤ê¸°
    function getMyRole() {
      if (!peer) return 'user';
      
      const myParticipant = participants[peer.id];
      if (!myParticipant) return 'user';
      
      if (myParticipant.isHost) return 'host';
      if (myParticipant.isManager) return 'manager';
      return 'user';
    }
    
    // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function displayMessage(message) {
      const messageEl = document.createElement('div');
      messageEl.className = 'message';
      
      const avatarEl = document.createElement('div');
      avatarEl.className = 'message-avatar';
      
      // ì—­í• ì— ë”°ë¥¸ ì•„ë°”íƒ€ ìŠ¤íƒ€ì¼ ë³€ê²½
      if (message.role === 'host') {
        avatarEl.classList.add('admin');
      } else if (message.role === 'manager') {
        avatarEl.classList.add('manager');
      }
      
      avatarEl.textContent = message.sender.charAt(0).toUpperCase();
      
      const contentEl = document.createElement('div');
      contentEl.className = 'message-content';
      
      const senderEl = document.createElement('div');
      senderEl.className = 'message-sender';
      senderEl.textContent = message.sender;
      
      // ì—­í•  ë°°ì§€ ì¶”ê°€
      if (message.role === 'host') {
        const badgeEl = document.createElement('span');
        badgeEl.className = 'sender-badge host';
        badgeEl.textContent = 'ë°©ì¥';
        senderEl.appendChild(badgeEl);
      } else if (message.role === 'manager') {
        const badgeEl = document.createElement('span');
        badgeEl.className = 'sender-badge manager';
        badgeEl.textContent = 'ë§¤ë‹ˆì €';
        senderEl.appendChild(badgeEl);
      }
      
      const textEl = document.createElement('div');
      textEl.className = 'message-text';
      textEl.innerHTML = linkify(message.content); // ë§í¬ ë° ì´ëª¨ì§€ ì²˜ë¦¬
      
      contentEl.appendChild(senderEl);
      contentEl.appendChild(textEl);
      
      messageEl.appendChild(avatarEl);
      messageEl.appendChild(contentEl);
      
      chatArea.appendChild(messageEl);
      chatArea.scrollTop = chatArea.scrollHeight;
    }
    
    // í…ìŠ¤íŠ¸ì—ì„œ URLì„ ë§í¬ë¡œ ë³€í™˜
    function linkify(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, url => `<a href="${url}" target="_blank" style="color: #81a1c1;">${url}</a>`);
    }
    
    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function displaySystemMessage(message) {
      const messageEl = document.createElement('div');
      messageEl.className = 'message';
      messageEl.style.justifyContent = 'center';
      
      const textEl = document.createElement('div');
      textEl.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
      textEl.style.padding = '10px 16px';
      textEl.style.borderRadius = '6px';
      textEl.style.fontSize = '14px';
      textEl.style.color = 'rgba(255, 255, 255, 0.7)';
      textEl.textContent = message;
      
      messageEl.appendChild(textEl);
      chatArea.appendChild(messageEl);
      chatArea.scrollTop = chatArea.scrollHeight;
    }
    
    // ì°¸ì—¬ ìš”ì²­ í‘œì‹œ í•¨ìˆ˜
    function displayJoinRequest(request) {
      const requestEl = document.createElement('div');
      requestEl.className = 'join-request';
      requestEl.id = `join-request-${request.peerId}`;
      
      const requestInfoEl = document.createElement('div');
      requestInfoEl.className = 'join-request-info';
      
      const avatarEl = document.createElement('div');
      avatarEl.className = 'join-request-avatar';
      avatarEl.textContent = request.nickname.charAt(0).toUpperCase();
      
      const nameEl = document.createElement('div');
      nameEl.className = 'join-request-name';
      nameEl.textContent = request.nickname;
      
      const buttonsEl = document.createElement('div');
      buttonsEl.className = 'join-request-buttons';
      
      const acceptBtn = document.createElement('button');
      acceptBtn.className = 'join-request-button accept';
      acceptBtn.textContent = 'ìˆ˜ë½';
      acceptBtn.addEventListener('click', () => {
        acceptJoinRequest(request.peerId);
      });
      
      const rejectBtn = document.createElement('button');
      rejectBtn.className = 'join-request-button reject';
      rejectBtn.textContent = 'ê±°ì ˆ';
      rejectBtn.addEventListener('click', () => {
        rejectJoinRequest(request.peerId);
      });
      
      requestInfoEl.appendChild(avatarEl);
      requestInfoEl.appendChild(nameEl);
      
      buttonsEl.appendChild(acceptBtn);
      buttonsEl.appendChild(rejectBtn);
      
      requestEl.appendChild(requestInfoEl);
      requestEl.appendChild(buttonsEl);
      
      joinRequestsList.appendChild(requestEl);
      joinRequestsContainer.style.display = 'block';
      
      // ì•Œë¦¼ í‘œì‹œ
      showNotification('CCHAT - ìƒˆ ì°¸ì—¬ ìš”ì²­', `${request.nickname}ë‹˜ì´ ë°©ì— ì°¸ì—¬í•˜ë ¤ê³  í•©ë‹ˆë‹¤.`);
    }
    
    // ë°© ë§Œë“¤ê¸° í•¨ìˆ˜
    function createRoom(userNickname, roomName) {
      nickname = userNickname;
      currentRoomName = roomName;
      
      // ì½”ë“œ íƒ€ì… í™•ì¸ (ë¬¸ì ë˜ëŠ” ìˆ«ì)
      const useNumberCode = document.getElementById('code-type-numbers').checked;
      
      // ì½”ë“œ ìƒì„±
      let shortCode;
      if (useNumberCode) {
        // 4ìë¦¬ ìˆ«ì ì½”ë“œ
        shortCode = generateRandomNumberCode(4);
      } else {
        // 3ìë¦¬ ë¬¸ì ì½”ë“œ
        shortCode = generateRandomCode(3);
      }
      
      currentRoomId = isPublicRoom ? publicRoomPrefix + shortCode : shortCode;
      
      // PeerJS ì´ˆê¸°í™”
      initializePeer(currentRoomId);
      
      // í™”ë©´ ì „í™˜
      showScreen('chat-container');
    }
    
    // ë°© ì°¸ì—¬í•˜ê¸° í•¨ìˆ˜
    function joinRoom(userNickname, roomCode, isDirectInvite) {
      nickname = userNickname;
      
      // ì½”ë“œ í˜•ì‹ ê°ì§€ ì²˜ë¦¬
      if (roomCode.length === 3 && isNaN(roomCode)) {
        // 3ìë¦¬ ë¬¸ì ì½”ë“œ
        // ê³µê°œë°©ì¸ì§€ í™•ì¸
        if (publicRooms.some(room => room.id.slice(-3) === roomCode)) {
          // ê³µê°œë°©ì¸ ê²½ìš° ì ‘ë‘ì‚¬ ì¶”ê°€
          currentRoomId = publicRoomPrefix + roomCode;
        } else {
          // ì¼ë°˜ ì´ˆëŒ€ ì½”ë“œì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ì‚¬ìš©
          currentRoomId = roomCode;
        }
      } else if (roomCode.length === 4 && !isNaN(roomCode)) {
        // 4ìë¦¬ ìˆ«ì ì½”ë“œ
        // ê³µê°œë°©ì¸ì§€ í™•ì¸
        if (publicRooms.some(room => room.id.slice(-4) === roomCode)) {
          // ê³µê°œë°©ì¸ ê²½ìš° ì ‘ë‘ì‚¬ ì¶”ê°€
          currentRoomId = publicRoomPrefix + roomCode;
        } else {
          // ì¼ë°˜ ì´ˆëŒ€ ì½”ë“œì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ì‚¬ìš©
          currentRoomId = roomCode;
        }
      } else {
        // ì „ì²´ ê¸¸ì´ ì½”ë“œëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš©
        currentRoomId = roomCode;
      }
      
      // PeerJS ì´ˆê¸°í™” (ëœë¤ IDë¡œ)
      initializePeer(null, isDirectInvite);
      
      // í™”ë©´ ì „í™˜
      showScreen('chat-container');
      
      // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
      updateConnectionStatus('connecting');
    }
    
    // ë°© ë‚˜ê°€ê¸° í•¨ìˆ˜
    function leaveRoom() {
      // ëª¨ë“  ì—°ê²° ì¢…ë£Œ
      Object.values(connections).forEach(conn => {
        conn.close();
      });
      
      // PeerJS ì—°ê²° ì¢…ë£Œ
      if (peer) {
        peer.destroy();
      }
      
      // ìƒíƒœ ì´ˆê¸°í™”
      connections = {};
      currentRoomId = null;
      currentRoomName = '';
      participants = {};
      joinRequests = {};
      
      // í™”ë©´ ì „í™˜
      showScreen('welcome-screen');
    }
    
    // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateConnectionStatus(status) {
      const statusIndicator = connectedStatus.querySelector('.status-indicator');
      
      switch (status) {
        case 'connecting':
          statusIndicator.className = 'status-indicator connecting';
          connectedStatus.querySelector('span:not(.status-indicator)').textContent = 'ì—°ê²° ì¤‘...';
          break;
          
        case 'connected':
          statusIndicator.className = 'status-indicator online';
          connectedStatus.querySelector('span:not(.status-indicator)').textContent = 'ì—°ê²°ë¨';
          break;
      }
    }
    
    // PeerJS ì´ˆê¸°í™” í•¨ìˆ˜
    function initializePeer(customId = null, isDirectInvite = true) {
      const peerId = customId || generatePeerId();
      
      peer = new Peer(peerId);
      
      peer.on('open', id => {
        console.log('ë‚´ í”¼ì–´ ID:', id);
        
        // ë°©ì¥ì´ ì•„ë‹Œ ê²½ìš° ë°©ì¥ì—ê²Œ ì—°ê²°
        if (!customId) {
          connectToHost(currentRoomId, isDirectInvite);
        } else {
          // ë°©ì¥ì¸ ê²½ìš° ì°¸ê°€ì ëª©ë¡ì— ìì‹  ì¶”ê°€
          participants[id] = {
            id: id,
            nickname: nickname,
            isHost: true,
            isManager: false
          };
          
          // ë°© ì •ë³´ ì—…ë°ì´íŠ¸
          updateRoomInfo();
          updateParticipantsList();
          
          // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
          displaySystemMessage(`'${currentRoomName}' ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
      });
      
      peer.on('connection', conn => {
        handleConnection(conn);
      });
      
      peer.on('error', err => {
        console.error('í”¼ì–´ ì—ëŸ¬:', err);
        if (err.type === 'peer-unavailable') {
          alert('ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ˆëŒ€ ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
          showScreen('welcome-screen');
        }
      });
    }
    
    // í˜¸ìŠ¤íŠ¸ì— ì—°ê²°í•˜ëŠ” í•¨ìˆ˜
    function connectToHost(hostId, isDirectInvite) {
      const conn = peer.connect(hostId);
      
      conn.on('open', () => {
        console.log('í˜¸ìŠ¤íŠ¸ì— ì—°ê²°ë¨');
        
        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        updateConnectionStatus('connected');
        
        // ì´ˆëŒ€ ì½”ë“œë¡œ ì§ì ‘ ì°¸ì—¬í•˜ëŠ” ê²½ìš°ì™€ ê³µê°œ ë°© ëª©ë¡ì—ì„œ ì°¸ì—¬í•˜ëŠ” ê²½ìš° êµ¬ë¶„
        if (isDirectInvite) {
          // ì§ì ‘ ì´ˆëŒ€ì¸ ê²½ìš° ë°”ë¡œ ì°¸ì—¬
          conn.send({
            type: 'join',
            peerId: peer.id,
            nickname: nickname,
            isDirectInvite: true
          });
        } else {
          // ê³µê°œ ë°© ëª©ë¡ì—ì„œ ì°¸ì—¬í•˜ëŠ” ê²½ìš° ìŠ¹ì¸ ìš”ì²­
          conn.send({
            type: 'join_request',
            peerId: peer.id,
            nickname: nickname
          });
          
          // ë©”ì‹œì§€ í‘œì‹œ
          displaySystemMessage('ë°©ì¥ì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
        }
        
        handleConnection(conn);
      });
      
      conn.on('error', () => {
        alert('ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ˆëŒ€ ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        showScreen('welcome-screen');
      });
    }
    
    // ì—°ê²° ì²˜ë¦¬ í•¨ìˆ˜
    function handleConnection(conn) {
      conn.on('data', data => {
        handleData(conn, data);
      });
      
      conn.on('close', () => {
        // ì—°ê²°ì´ ëŠê¸´ ì°¸ê°€ì ì œê±°
        if (connections[conn.peer]) {
          delete connections[conn.peer];
        }
        
        if (participants[conn.peer]) {
          const leavingNickname = participants[conn.peer].nickname;
          
          // ë°©ì¥ì´ ë‚˜ê°„ ê²½ìš° ìƒˆ ë°©ì¥ ì„ ì •
          if (participants[conn.peer].isHost && Object.keys(participants).length > 1) {
            assignNewHost();
          }
          
          delete participants[conn.peer];
          updateParticipantsList();
          
          // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
          displaySystemMessage(`${leavingNickname}ë‹˜ì´ ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.`);
        }
      });
      
      connections[conn.peer] = conn;
    }
    
    // ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜
    function handleData(conn, data) {
      console.log('ë°›ì€ ë°ì´í„°:', data);
      
      switch (data.type) {
        case 'join':
          // ì§ì ‘ ì´ˆëŒ€ë¡œ ìƒˆ ì°¸ê°€ì ì…ì¥
          participants[data.peerId] = {
            id: data.peerId,
            nickname: data.nickname,
            isHost: false,
            isManager: false
          };
          
          // ë°© ì •ë³´ ì „ì†¡
          conn.send({
            type: 'room_info',
            roomName: currentRoomName,
            participants: participants
          });
          
          // ë‹¤ë¥¸ ì°¸ê°€ìë“¤ì—ê²Œ ìƒˆ ì°¸ê°€ì ì •ë³´ ì „ì†¡
          Object.values(connections).forEach(c => {
            if (c.peer !== conn.peer) {
              c.send({
                type: 'new_participant',
                participant: participants[data.peerId]
              });
            }
          });
          
          updateParticipantsList();
          
          // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
          displaySystemMessage(`${data.nickname}ë‹˜ì´ ë°©ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤.`);
          break;
          
        case 'join_request':
          // ì°¸ì—¬ ìš”ì²­ ì €ì¥
          joinRequests[data.peerId] = {
            peerId: data.peerId,
            nickname: data.nickname,
            conn: conn
          };
          
          // ìš”ì²­ í‘œì‹œ (ë°©ì¥ ë˜ëŠ” ë§¤ë‹ˆì €ë§Œ)
          if (participants[peer.id] && (participants[peer.id].isHost || participants[peer.id].isManager)) {
            displayJoinRequest(joinRequests[data.peerId]);
          }
          break;
          
        case 'join_request_approved':
          // ì°¸ì—¬ ìš”ì²­ì´ ìŠ¹ì¸ë¨
          currentRoomName = data.roomName;
          participants = data.participants;
          
          // ìì‹ ì„ ì°¸ê°€ì ëª©ë¡ì— ì¶”ê°€
          participants[peer.id] = {
            id: peer.id,
            nickname: nickname,
            isHost: false,
            isManager: false
          };
          
          updateRoomInfo();
          updateParticipantsList();
          
          // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
          displaySystemMessage('ë°©ì¥ì´ ì°¸ì—¬ ìš”ì²­ì„ ìŠ¹ì¸í–ˆìŠµë‹ˆë‹¤.');
          break;
          
        case 'join_request_rejected':
          // ì°¸ì—¬ ìš”ì²­ì´ ê±°ì ˆë¨
          displaySystemMessage('ë°©ì¥ì´ ì°¸ì—¬ ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.');
          setTimeout(() => {
            leaveRoom();
          }, 2000);
          break;
          
        case 'room_info':
          // ë°© ì •ë³´ ì—…ë°ì´íŠ¸
          currentRoomName = data.roomName;
          participants = data.participants;
          
          // ìì‹ ì„ ì°¸ê°€ì ëª©ë¡ì— ì¶”ê°€
          participants[peer.id] = {
            id: peer.id,
            nickname: nickname,
            isHost: false,
            isManager: false
          };
          
          updateRoomInfo();
          updateParticipantsList();
          break;
          
        case 'new_participant':
          // ìƒˆ ì°¸ê°€ì ì •ë³´ ì—…ë°ì´íŠ¸
          participants[data.participant.id] = data.participant;
          updateParticipantsList();
          
          // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
          displaySystemMessage(`${data.participant.nickname}ë‹˜ì´ ë°©ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤.`);
          break;
          
        case 'message':
          // ë©”ì‹œì§€ í‘œì‹œ
          displayMessage(data);
          
          // ì•Œë¦¼ í‘œì‹œ
          showNotification(`CCHAT - ${data.sender}ë‹˜ì˜ ë©”ì‹œì§€`, data.content);
          break;
          
        case 'room_info_request':
          // ê³µê°œ ë°© ì •ë³´ ìš”ì²­ì— ì‘ë‹µ
          if (isPublicRoom && participants[peer.id].isHost) {
            conn.send({
              type: 'room_info_response',
              roomName: currentRoomName,
              participantsCount: Object.keys(participants).length
            });
          }
          break;
          
        case 'promote_to_manager':
          // ë§¤ë‹ˆì €ë¡œ ìŠ¹ê²©
          if (data.targetId === peer.id) {
            participants[peer.id].isManager = true;
            updateParticipantsList();
            
            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
            displaySystemMessage('ë°©ì¥ì´ ë‹¹ì‹ ì„ ë§¤ë‹ˆì €ë¡œ ìŠ¹ê²©ì‹œì¼°ìŠµë‹ˆë‹¤.');
          } else if (participants[data.targetId]) {
            participants[data.targetId].isManager = true;
            updateParticipantsList();
          }
          break;
          
        case 'demote_from_manager':
          // ë§¤ë‹ˆì € ê¶Œí•œ í•´ì œ
          if (data.targetId === peer.id) {
            participants[peer.id].isManager = false;
            updateParticipantsList();
            
            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
            displaySystemMessage('ë°©ì¥ì´ ë‹¹ì‹ ì˜ ë§¤ë‹ˆì € ê¶Œí•œì„ í•´ì œí–ˆìŠµë‹ˆë‹¤.');
          } else if (participants[data.targetId]) {
            participants[data.targetId].isManager = false;
            updateParticipantsList();
          }
          break;
          
        case 'host_changed':
          // ë°©ì¥ ë³€ê²½
          Object.keys(participants).forEach(id => {
            participants[id].isHost = (id === data.newHostId);
          });
          
          updateParticipantsList();
          
          // ë°©ì¥ì´ ëœ ê²½ìš°
          if (data.newHostId === peer.id) {
            displaySystemMessage('ë‹¹ì‹ ì´ ìƒˆë¡œìš´ ë°©ì¥ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } else {
            const newHostName = participants[data.newHostId]?.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ';
            displaySystemMessage(`${newHostName}ë‹˜ì´ ìƒˆë¡œìš´ ë°©ì¥ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          }
          break;
      }
    }
    
    // ì°¸ì—¬ ìš”ì²­ ìˆ˜ë½
    function acceptJoinRequest(peerId) {
      if (!joinRequests[peerId]) return;
      
      const request = joinRequests[peerId];
      
      // ì°¸ê°€ì ëª©ë¡ì— ì¶”ê°€
      participants[peerId] = {
        id: peerId,
        nickname: request.nickname,
        isHost: false,
        isManager: false
      };
      
      // ì°¸ì—¬ ìŠ¹ì¸ ë©”ì‹œì§€ ì „ì†¡
      request.conn.send({
        type: 'join_request_approved',
        roomName: currentRoomName,
        participants: participants
      });
      
      // ë‹¤ë¥¸ ì°¸ê°€ìë“¤ì—ê²Œ ìƒˆ ì°¸ê°€ì ì •ë³´ ì „ì†¡
      Object.values(connections).forEach(conn => {
        if (conn.peer !== peerId) {
          conn.send({
            type: 'new_participant',
            participant: participants[peerId]
          });
        }
      });
      
      // ìš”ì²­ ëª©ë¡ì—ì„œ ì œê±°
      removeJoinRequest(peerId);
      
      // ì°¸ê°€ì ëª©ë¡ ì—…ë°ì´íŠ¸
      updateParticipantsList();
      
      // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
      displaySystemMessage(`${request.nickname}ë‹˜ì˜ ì°¸ì—¬ ìš”ì²­ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤.`);
    }
    
    // ì°¸ì—¬ ìš”ì²­ ê±°ì ˆ
    function rejectJoinRequest(peerId) {
      if (!joinRequests[peerId]) return;
      
      const request = joinRequests[peerId];
      
      // ê±°ì ˆ ë©”ì‹œì§€ ì „ì†¡
      request.conn.send({
        type: 'join_request_rejected'
      });
      
      // ìš”ì²­ ëª©ë¡ì—ì„œ ì œê±°
      removeJoinRequest(peerId);
      
      // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
      displaySystemMessage(`${request.nickname}ë‹˜ì˜ ì°¸ì—¬ ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.`);
    }
    
    // ì°¸ì—¬ ìš”ì²­ ì œê±°
    function removeJoinRequest(peerId) {
      if (!joinRequests[peerId]) return;
      
      // DOMì—ì„œ ìš”ì²­ ì œê±°
      const requestEl = document.getElementById(`join-request-${peerId}`);
      if (requestEl) {
        requestEl.remove();
      }
      
      // ìš”ì²­ ëª©ë¡ì—ì„œ ì œê±°
      delete joinRequests[peerId];
      
      // ìš”ì²­ì´ ì—†ëŠ” ê²½ìš° ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
      if (Object.keys(joinRequests).length === 0) {
        joinRequestsContainer.style.display = 'none';
      }
    }
    
    // ë§¤ë‹ˆì €ë¡œ ìŠ¹ê²©
    function promoteToManager(peerId) {
      if (!participants[peerId] || participants[peerId].isHost || participants[peerId].isManager) return;
      
      // ê¶Œí•œ ë³€ê²½
      participants[peerId].isManager = true;
      
      // ëª¨ë“  ì°¸ê°€ìì—ê²Œ ì•Œë¦¼
      Object.values(connections).forEach(conn => {
        conn.send({
          type: 'promote_to_manager',
          targetId: peerId
        });
      });
      
      // ì°¸ê°€ì ëª©ë¡ ì—…ë°ì´íŠ¸
      updateParticipantsList();
      
      // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
      const targetName = participants[peerId].nickname;
      displaySystemMessage(`${targetName}ë‹˜ì„ ë§¤ë‹ˆì €ë¡œ ìŠ¹ê²©ì‹œì¼°ìŠµë‹ˆë‹¤.`);
    }
    
    // ë§¤ë‹ˆì € ê¶Œí•œ í•´ì œ
    function demoteFromManager(peerId) {
      if (!participants[peerId] || participants[peerId].isHost || !participants[peerId].isManager) return;
      
      // ê¶Œí•œ ë³€ê²½
      participants[peerId].isManager = false;
      
      // ëª¨ë“  ì°¸ê°€ìì—ê²Œ ì•Œë¦¼
      Object.values(connections).forEach(conn => {
        conn.send({
          type: 'demote_from_manager',
          targetId: peerId
        });
      });
      
      // ì°¸ê°€ì ëª©ë¡ ì—…ë°ì´íŠ¸
      updateParticipantsList();
      
      // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
      const targetName = participants[peerId].nickname;
      displaySystemMessage(`${targetName}ë‹˜ì˜ ë§¤ë‹ˆì € ê¶Œí•œì„ í•´ì œí–ˆìŠµë‹ˆë‹¤.`);
    }
    
    // ë°©ì¥ ìœ„ì„
    function assignNewHost(targetId = null) {
      let newHostId;
      
      if (targetId && participants[targetId]) {
        // ì§€ì •ëœ ì°¸ê°€ìê°€ ìˆëŠ” ê²½ìš°
        newHostId = targetId;
      } else {
        // ìë™ ì„ íƒ: ë§¤ë‹ˆì € ìš°ì„ , ì—†ìœ¼ë©´ ì•„ë¬´ë‚˜
        const managers = Object.values(participants).filter(p => p.isManager && !p.isHost);
        if (managers.length > 0) {
          newHostId = managers[0].id;
        } else {
          const nonHosts = Object.values(participants).filter(p => !p.isHost);
          if (nonHosts.length > 0) {
            newHostId = nonHosts[0].id;
          } else {
            return; // ë°©ì¥ë§Œ ìˆëŠ” ê²½ìš°
          }
        }
      }
      
      // ë°©ì¥ ê¶Œí•œ ë³€ê²½
      Object.keys(participants).forEach(id => {
        participants[id].isHost = (id === newHostId);
      });
      
      // ëª¨ë“  ì°¸ê°€ìì—ê²Œ ì•Œë¦¼
      Object.values(connections).forEach(conn => {
        conn.send({
          type: 'host_changed',
          newHostId: newHostId
        });
      });
      
      // ì°¸ê°€ì ëª©ë¡ ì—…ë°ì´íŠ¸
      updateParticipantsList();
      
      // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
      const newHostName = participants[newHostId].nickname;
      displaySystemMessage(`${newHostName}ë‹˜ì´ ìƒˆë¡œìš´ ë°©ì¥ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }
    
    // ì°¸ê°€ì ê°•ì œ í‡´ì¥
    function kickParticipant(peerId) {
      if (!participants[peerId]) return;
      
      const targetConn = connections[peerId];
      if (targetConn) {
        targetConn.close();
      }
      
      const targetName = participants[peerId].nickname;
      delete participants[peerId];
      delete connections[peerId];
      
      // ëª¨ë“  ì°¸ê°€ìì—ê²Œ ì•Œë¦¼
      Object.values(connections).forEach(conn => {
        conn.send({
          type: 'message',
          sender: 'System',
          content: `${targetName}ë‹˜ì´ ê°•ì œ í‡´ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`,
          timestamp: Date.now(),
          role: 'system'
        });
      });
      
      // ì°¸ê°€ì ëª©ë¡ ì—…ë°ì´íŠ¸
      updateParticipantsList();
      
      // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
      displaySystemMessage(`${targetName}ë‹˜ì„ ê°•ì œ í‡´ì¥ì‹œì¼°ìŠµë‹ˆë‹¤.`);
    }
    
    // ë°© ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateRoomInfo() {
      currentRoomNameEl.textContent = currentRoomName;
      roomHeaderEl.textContent = currentRoomName;
      
      // ë°© ì½”ë“œ ê¸¸ì´ì— ë”°ë¼ ë‹¤ë¥´ê²Œ í‘œì‹œ (3ìë¦¬ ë¬¸ì ë˜ëŠ” 4ìë¦¬ ìˆ«ì)
      const codeLength = isNaN(currentRoomId.slice(-4)) ? 3 : 4;
      inviteCodeDisplay.textContent = currentRoomId.slice(-codeLength);
    }
    
    // ì°¸ê°€ì ëª©ë¡ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateParticipantsList() {
      participantsList.innerHTML = '';
      
      // ë°©ì¥ ë¨¼ì €, ë§¤ë‹ˆì € ë‹¤ìŒ, ì¼ë°˜ ì°¸ê°€ì ìˆœìœ¼ë¡œ ì •ë ¬
      const sortedParticipants = Object.values(participants).sort((a, b) => {
        if (a.isHost) return -1;
        if (b.isHost) return 1;
        if (a.isManager) return -1;
        if (b.isManager) return 1;
        return 0;
      });
      
      sortedParticipants.forEach(participant => {
        const participantEl = document.createElement('div');
        participantEl.className = 'room-item';
        participantEl.dataset.peerId = participant.id;
        
        const avatarEl = document.createElement('div');
        avatarEl.className = 'room-item-avatar';
        if (participant.isHost) {
          avatarEl.style.backgroundColor = 'var(--warning)';
        } else if (participant.isManager) {
          avatarEl.style.backgroundColor = 'var(--success)';
        }
        avatarEl.textContent = participant.nickname.charAt(0).toUpperCase();
        
        const infoEl = document.createElement('div');
        infoEl.className = 'room-item-info';
        
        const nameEl = document.createElement('div');
        nameEl.className = 'room-item-name';
        nameEl.textContent = participant.nickname;
        
        if (participant.isHost) {
          const badgeEl = document.createElement('span');
          badgeEl.className = 'room-item-badge';
          badgeEl.style.backgroundColor = 'var(--warning)';
          badgeEl.textContent = 'ë°©ì¥';
          nameEl.appendChild(badgeEl);
        } else if (participant.isManager) {
          const badgeEl = document.createElement('span');
          badgeEl.className = 'room-item-badge';
          badgeEl.style.backgroundColor = 'var(--success)';
          badgeEl.textContent = 'ë§¤ë‹ˆì €';
          nameEl.appendChild(badgeEl);
        }
        
        infoEl.appendChild(nameEl);
        
        participantEl.appendChild(avatarEl);
        participantEl.appendChild(infoEl);
        
        // ë°©ì¥ì¸ ê²½ìš° ì°¸ê°€ì ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì¶”ê°€
        if (participants[peer.id] && (participants[peer.id].isHost || participants[peer.id].isManager) && participant.id !== peer.id) {
          participantEl.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showParticipantContextMenu(e, participant);
          });
        }
        
        participantsList.appendChild(participantEl);
      });
    }
    
    // ì°¸ê°€ì ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í‘œì‹œ
    function showParticipantContextMenu(event, participant) {
      const rect = event.target.getBoundingClientRect();
      
      contextMenu.innerHTML = '';
      contextMenu.style.top = `${event.clientY}px`;
      contextMenu.style.left = `${event.clientX}px`;
      
      // ë°©ì¥ ì „ìš© ë©”ë‰´
      if (participants[peer.id] && participants[peer.id].isHost) {
        if (!participant.isManager) {
          const promoteItem = document.createElement('div');
          promoteItem.className = 'context-menu-item';
          promoteItem.textContent = 'ë§¤ë‹ˆì €ë¡œ ìŠ¹ê²©';
          promoteItem.addEventListener('click', () => {
            promoteToManager(participant.id);
            contextMenu.classList.remove('active');
          });
          contextMenu.appendChild(promoteItem);
        } else {
          const demoteItem = document.createElement('div');
          demoteItem.className = 'context-menu-item';
          demoteItem.textContent = 'ë§¤ë‹ˆì € ê¶Œí•œ í•´ì œ';
          demoteItem.addEventListener('click', () => {
            demoteFromManager(participant.id);
            contextMenu.classList.remove('active');
          });
          contextMenu.appendChild(demoteItem);
        }
        
        const transferHostItem = document.createElement('div');
        transferHostItem.className = 'context-menu-item';
        transferHostItem.textContent = 'ë°©ì¥ ìœ„ì„';
        transferHostItem.addEventListener('click', () => {
          assignNewHost(participant.id);
          contextMenu.classList.remove('active');
        });
        contextMenu.appendChild(transferHostItem);
      }
      
      // ë°©ì¥ê³¼ ë§¤ë‹ˆì € ê³µí†µ ë©”ë‰´
      const kickItem = document.createElement('div');
      kickItem.className = 'context-menu-item danger';
      kickItem.textContent = 'ê°•ì œ í‡´ì¥';
      kickItem.addEventListener('click', () => {
        showConfirmation(`${participant.nickname}ë‹˜ì„ ê°•ì œë¡œ í‡´ì¥ì‹œí‚¤ê² ìŠµë‹ˆê¹Œ?`, () => {
          kickParticipant(participant.id);
        });
        contextMenu.classList.remove('active');
      });
      contextMenu.appendChild(kickItem);
      
      // ë©”ë‰´ í‘œì‹œ
      contextMenu.classList.add('active');
    }
    
    // ë¬¸ì ëœë¤ ì½”ë“œ ìƒì„± (3ìë¦¬)
    function generateRandomCode(length) {
      const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let result = '';
      
      for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
      }
      
      return result;
    }
    
    // ìˆ«ì ëœë¤ ì½”ë“œ ìƒì„± (4ìë¦¬)
    function generateRandomNumberCode(length) {
      let result = '';
      
      for (let i = 0; i < length; i++) {
        result += Math.floor(Math.random() * 10);
      }
      
      return result;
    }
    
    // ê³ ìœ í•œ í”¼ì–´ ID ìƒì„± í•¨ìˆ˜
    function generatePeerId() {
      return 'peer-' + Math.random().toString(36).substr(2, 9);
    }
    
    // ì´ˆê¸°í™” ì‹¤í–‰
    init();
  </script>
</body>
</html>
